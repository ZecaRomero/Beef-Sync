"use strict";(()=>{var a={};a.id=2143,a.ids=[2143],a.modules={3524:a=>{a.exports=require("@prisma/client")},145:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6314:(a,e,o)=>{o.r(e),o.d(e,{config:()=>d,default:()=>l,routeModule:()=>u});var t={};o.r(t),o.d(t,{default:()=>handler});var s=o(1802),r=o(7153),n=o(6249),i=o(7864);async function handler(a,e){if("POST"!==a.method)return e.status(405).json({message:"Method not allowed"});try{console.log("\uD83D\uDD04 Iniciando atualiza\xe7\xe3o financeira...");let a=await i._.animal.findMany({where:{status:"VENDIDO",valorVenda:{not:null}},include:{costs:!0}});console.log(`ðŸ“Š Encontrados ${a.length} animais vendidos`);let o=0;for(let e of a){let a=e.costs.find(a=>"VENDA"===a.tipo);!a&&e.valorVenda&&(await i._.cost.create({data:{tipo:"VENDA",descricao:`Venda do animal ${e.brinco}`,valor:parseFloat(e.valorVenda),data:e.dataVenda||new Date,animalId:e.id,observacoes:`Venda registrada no leil\xe3o por R$ ${parseFloat(e.valorVenda).toLocaleString("pt-BR")}`,userId:e.userId}}),o++,console.log(`ðŸ’° Custo de venda criado para ${e.brinco}: R$ ${e.valorVenda}`))}let t=await i._.cost.aggregate({where:{tipo:"VENDA"},_sum:{valor:!0},_count:{id:!0}}),s=await i._.cost.aggregate({where:{tipo:{not:"VENDA"}},_sum:{valor:!0}}),r={totalSalesValue:t._sum.valor||0,totalSalesCount:t._count||0,totalCosts:s._sum.valor||0,profit:(t._sum.valor||0)-(s._sum.valor||0),updatedAnimals:o};console.log("\uD83D\uDCC8 Estat\xedsticas financeiras:",r),e.status(200).json({success:!0,message:`Financeiro atualizado! ${o} animais processados.`,stats:r})}catch(a){console.error("âŒ Erro ao atualizar financeiro:",a),e.status(500).json({success:!1,message:"Erro ao atualizar dados financeiros",error:a.message})}}let l=(0,n.l)(t,"default"),d=(0,n.l)(t,"config"),u=new s.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/update-financial",pathname:"/api/update-financial",bundlePath:"",filename:""},userland:t})},7864:(a,e,o)=>{o.d(e,{_:()=>r});var t=o(3524);let s=globalThis,r=s.prisma||new t.PrismaClient}};var e=require("../../webpack-api-runtime.js");e.C(a);var __webpack_exec__=a=>e(e.s=a),o=e.X(0,[4222],()=>__webpack_exec__(6314));module.exports=o})();