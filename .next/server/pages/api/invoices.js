"use strict";(()=>{var a={};a.id=1499,a.ids=[1499],a.modules={3524:a=>{a.exports=require("@prisma/client")},145:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},344:(a,e,i)=>{i.r(e),i.d(e,{config:()=>c,default:()=>s,routeModule:()=>u});var r={};i.r(r),i.d(r,{default:()=>handler});var n=i(1802),t=i(7153),o=i(8781),d=i(3524);let l=new d.PrismaClient;async function handler(a,e){if("GET"===a.method)try{let a=await l.invoice.findMany({include:{animals:{include:{animal:!0}}},orderBy:{createdAt:"desc"}}),i=a.map(a=>({...a,animais:a.animals.map(a=>({id:a.animal.id,brinco:a.animal.brinco,nome:a.animal.nome,raca:a.animal.raca,sexo:a.animal.sexo,preco:a.preco}))}));e.status(200).json(i)}catch(a){console.error("Erro ao buscar notas fiscais:",a),e.status(500).json({error:"Erro interno do servidor"})}else if("POST"===a.method)try{let{numero:i,compradorNome:r,compradorCpfCnpj:n,compradorEndereco:t,compradorCidade:o,compradorEstado:d,compradorCep:s,animais:c,valorTotal:u,dataVenda:m,observacoes:p,status:w}=a.body,f=await l.invoice.create({data:{numero:i,compradorNome:r,compradorCpfCnpj:n,compradorEndereco:t,compradorCidade:o,compradorEstado:d,compradorCep:s,valorTotal:u,dataVenda:new Date(m),observacoes:p,status:w,animals:{create:c.map(a=>({animalId:a.id,preco:a.preco}))}},include:{animals:{include:{animal:!0}}}});for(let a of(await l.animal.updateMany({where:{id:{in:c.map(a=>a.id)}},data:{status:"VENDIDO",valorVenda:void 0}}),c))await l.animal.update({where:{id:a.id},data:{valorVenda:a.preco}});e.status(201).json(f)}catch(a){console.error("Erro ao criar nota fiscal:",a),e.status(500).json({error:"Erro interno do servidor"})}else if("PUT"===a.method)try{let{id:i,numero:r,compradorNome:n,compradorCpfCnpj:t,compradorEndereco:o,compradorCidade:d,compradorEstado:s,compradorCep:c,animais:u,valorTotal:m,dataVenda:p,observacoes:w,status:f}=a.body,h=await l.invoice.findUnique({where:{id:i},include:{animals:!0}});if(!h)return e.status(404).json({error:"Nota fiscal n\xe3o encontrada"});let v=h.animals.map(a=>a.animalId),y=u.map(a=>a.id),x=v.filter(a=>!y.includes(a)),E=y.filter(a=>!v.includes(a)),_=await l.invoice.update({where:{id:i},data:{numero:r,compradorNome:n,compradorCpfCnpj:t,compradorEndereco:o,compradorCidade:d,compradorEstado:s,compradorCep:c,valorTotal:m,dataVenda:new Date(p),observacoes:w,status:f,animals:{deleteMany:{},create:u.map(a=>({animalId:a.id,preco:a.preco}))}},include:{animals:{include:{animal:!0}}}});for(let a of(x.length>0&&await l.animal.updateMany({where:{id:{in:x}},data:{status:"ATIVO",valorVenda:null}}),E.length>0&&await l.animal.updateMany({where:{id:{in:E}},data:{status:"VENDIDO"}}),u))await l.animal.update({where:{id:a.id},data:{valorVenda:a.preco}});e.status(200).json(_)}catch(a){console.error("Erro ao atualizar nota fiscal:",a),e.status(500).json({error:"Erro interno do servidor"})}else e.setHeader("Allow",["GET","POST","PUT"]),e.status(405).end(`Method ${a.method} Not Allowed`)}let s=(0,o.l)(r,"default"),c=(0,o.l)(r,"config"),u=new n.PagesAPIRouteModule({definition:{kind:t.x.PAGES_API,page:"/api/invoices",pathname:"/api/invoices",bundlePath:"",filename:""},userland:r})}};var e=require("../../webpack-api-runtime.js");e.C(a);var __webpack_exec__=a=>e(e.s=a),i=e.X(0,[4222],()=>__webpack_exec__(344));module.exports=i})();